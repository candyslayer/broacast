# 录播功能完整实现文档

## 概述
本系统实现了完整的录播功能，包括实时录制、文件管理和历史记录查看，与直播流程无缝集成。

## 核心组件

### 1. RecordService - 录制服务
负责录制的整体管理和协调：
- 录制生命周期管理（开始/停止）
- 录制状态监控
- 文件管理和清理
- 历史记录维护

### 2. RecordManager - 录制管理器
处理具体的录制任务：
- 接收流数据
- 文件写入操作
- 录制状态更新
- 异常处理

### 3. RecordInfo - 录制信息模型
存储录制相关信息：
- 录制ID和房间ID
- 录制时间和状态
- 文件路径和大小
- 录制质量参数

## API接口详细说明

### 开始录制
```http
POST /api/record/start?roomId=xxx
```

**参数：**
- `roomId`: 房间ID（必填）

**响应：**
```json
{
  "code": 200,
  "message": "开始录制成功",
  "data": {
    "recordId": "20241221_123456",
    "roomId": "room001",
    "startTime": "2024-12-21T12:34:56.789Z",
    "status": "RECORDING",
    "filePath": "records/room001/20241221_123456.mp4"
  }
}
```

### 停止录制
```http
POST /api/record/stop?roomId=xxx
```

**参数：**
- `roomId`: 房间ID（必填）

**响应：**
```json
{
  "code": 200,
  "message": "停止录制成功",
  "data": null
}
```

### 获取活跃录制列表
```http
GET /api/record/list
```

**响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "room001": {
      "recordId": "20241221_123456",
      "roomId": "room001",
      "startTime": "2024-12-21T12:34:56.789Z",
      "status": "RECORDING",
      "filePath": "records/room001/20241221_123456.mp4"
    }
  }
}
```

### 获取录制历史
```http
GET /api/record/history?roomId=xxx
```

**参数：**
- `roomId`: 房间ID（可选，不填则返回所有房间历史）

**响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "recordId": "20241221_123456",
      "roomId": "room001",
      "startTime": "2024-12-21T12:34:56.789Z",
      "endTime": "2024-12-21T13:34:56.789Z",
      "status": "COMPLETED",
      "filePath": "records/room001/20241221_123456.mp4",
      "fileSize": 1048576,
      "duration": 3600
    }
  ]
}
```

### 下载录制文件
```http
GET /api/record/download?roomId=xxx&recordId=xxx
```

**参数：**
- `roomId`: 房间ID（必填）
- `recordId`: 录制ID（必填）

**响应：**
- 成功：返回MP4文件流
- 失败：返回404状态码

### 删除录制文件
```http
DELETE /api/record/delete?roomId=xxx&recordId=xxx
```
或
```http
POST /api/record/delete?roomId=xxx&recordId=xxx
```

**参数：**
- `roomId`: 房间ID（必填）
- `recordId`: 录制ID（必填）

**响应：**
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

## 文件存储结构

```
records/
├── room001/
│   ├── 20241221_123456.mp4
│   ├── 20241221_143210.mp4
│   └── ...
├── room002/
│   ├── 20241221_154321.mp4
│   └── ...
└── ...
```

## 录制流程

### 1. 开始录制流程
1. 接收到开始录制请求
2. 验证房间是否存在且正在直播
3. 检查是否已在录制（防重复）
4. 创建录制目录和文件
5. 启动录制任务
6. 注册为流数据消费者
7. 返回录制信息

### 2. 录制过程
1. 从StreamManager接收流数据
2. 将数据写入MP4文件
3. 定期更新录制状态
4. 监控磁盘空间和录制质量
5. 处理异常情况

### 3. 停止录制流程
1. 接收到停止录制请求
2. 停止数据写入
3. 关闭文件流
4. 更新录制状态为完成
5. 计算文件大小和录制时长
6. 清理资源

## 集成说明

### 与StreamManager集成
录制功能作为流数据的消费者，需要在StreamManager中注册：

```java
// 在StreamManager中添加录制消费者
public void addRecordConsumer(String roomId, RecordManager recordManager) {
    List<StreamConsumer> consumers = streamConsumers.get(roomId);
    if (consumers == null) {
        consumers = new ArrayList<>();
        streamConsumers.put(roomId, consumers);
    }
    consumers.add(recordManager);
}
```

### 与HTTP服务器集成
在HttpServerHandler中添加录播API路由处理，支持所有录制相关操作。

## 使用示例

### 前端JavaScript调用示例

```javascript
// 开始录制
async function startRecord(roomId) {
    const response = await fetch(`/api/record/start?roomId=${roomId}`, {
        method: 'POST'
    });
    const result = await response.json();
    console.log('录制开始:', result);
}

// 停止录制
async function stopRecord(roomId) {
    const response = await fetch(`/api/record/stop?roomId=${roomId}`, {
        method: 'POST'
    });
    const result = await response.json();
    console.log('录制停止:', result);
}

// 获取录制历史
async function getRecordHistory(roomId) {
    const url = roomId ? 
        `/api/record/history?roomId=${roomId}` : 
        `/api/record/history`;
    const response = await fetch(url);
    const result = await response.json();
    console.log('录制历史:', result.data);
}

// 下载录制文件
function downloadRecord(roomId, recordId) {
    const url = `/api/record/download?roomId=${roomId}&recordId=${recordId}`;
    const a = document.createElement('a');
    a.href = url;
    a.download = `${recordId}.mp4`;
    a.click();
}
```

## 配置参数

可以在RecordService中配置以下参数：

```java
// 录制文件保存路径
private static final String RECORD_BASE_PATH = "records";

// 最大并发录制数
private static final int MAX_CONCURRENT_RECORDS = 10;

// 录制质量配置
private static final String VIDEO_CODEC = "h264";
private static final String AUDIO_CODEC = "aac";
private static final int VIDEO_BITRATE = 2000; // kbps
private static final int AUDIO_BITRATE = 128; // kbps
```

## 注意事项

1. **存储空间**：录制会消耗大量存储空间，需要定期清理旧文件
2. **性能影响**：录制会增加服务器CPU和I/O负载
3. **并发限制**：建议限制同时录制的直播间数量
4. **异常处理**：需要处理磁盘满、权限不足等异常情况
5. **文件格式**：目前实现为MP4格式，可根据需要扩展其他格式

## 扩展功能

未来可以扩展的功能：
- 录制预设（不同分辨率、码率）
- 录制切片（按时间分段）
- 录制转码（生成多种格式）
- 录制云存储集成
- 录制内容审核
- 录制统计分析
